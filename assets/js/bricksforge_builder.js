var BRFBUILDER=BRFBUILDER||{};class BricksforgeBuilder{bricksPanelObserver=null;bricksStructureObserver=null;bricksRoot=null;bricksState=null;bricksContent=null;bricksActiveElement=null;bricksActiveElementObject=null;bricksforgeRoot=null;bricksforgeState=null;bricksforgeStores=null;bricksforgeStoreAi=null;bricksIframe=void 0!==document.querySelector("#bricks-builder-iframe")&&null!==document.querySelector("#bricks-builder-iframe")?document.querySelector("#bricks-builder-iframe").contentWindow.document:null;createTerminalShortcut=null;constructor(){this.init()}init(){this.createVueWrapper(),this.initVueInstances(),this.initMutationObservers(),this.initFunctions(),this.addContextMenuItems(),this.handleEventListeners()}createVueWrapper(){const e=document.createElement("div");e.id="bricksforge-builder";document.querySelector("#bricks-preview")&&document.querySelector("#bricks-preview").appendChild(e)}initVueInstances(){this.bricksRoot=document.querySelector(".brx-body").__vue_app__.config.globalProperties,this.bricksState=this.bricksRoot.$_state,this.bricksContent=this.bricksState.content,setTimeout((()=>{this.bricksforgeRoot=document.querySelector("#bricksforge-builder").__vue_app__?document.querySelector("#bricksforge-builder").__vue_app__.config.globalProperties:null,this.bricksforgeRoot&&(this.bricksforgeState=this.bricksforgeRoot.$pinia.state,this.bricksforgeStores=this.bricksforgeState._value,this.bricksforgeStoreAi=this.bricksforgeStores.ai,this.bricksIframe=void 0!==document.querySelector("#bricks-builder-iframe")&&null!==document.querySelector("#bricks-builder-iframe")?document.querySelector("#bricks-builder-iframe").contentWindow.document:null)}),2500)}refreshState(){this.bricksState=this.bricksRoot.$_state,this.bricksContent=this.bricksState.content}handleEventListeners(){document.addEventListener("click",(e=>{e.target.closest(".bricksforge-panel-handler")&&this.proFormsPanelClickHandler(e)}))}initMutationObservers(){this.bricksPanelObserver=new MutationObserver((e=>{if(this.getActiveElement(),"brf-pro-forms"===this.bricksActiveElement)this.handleProForms()})),this.bricksPanelObserver.observe(document.querySelector("#bricks-panel-inner"),{childList:!0,subtree:!0}),this.bricksStructureObserver=new MutationObserver((e=>{this.handleProFormsDuplicatedIds()})),this.bricksStructureObserver.observe(document.querySelector("#bricks-structure"),{childList:!0,subtree:!0})}initFunctions(){this.createTerminalShortcut=this.runCreateTerminalShortcut.bind(this)}addContextMenuItems(){"undefined"!=typeof BRFTERMINAL&&(this.createContextMenuItem("Create Terminal Command","BRFBUILDER.createTerminalShortcut()"),this.createContextMenuSeparator())}createContextMenuItem(e,t){let r=document.querySelector("#bricks-builder-context-menu ul");const i=document.createElement("li");i.id="brfCreateTerminalShortcut",i.innerHTML='<span class="label">'+e+"</span>",i.setAttribute("onclick",t);let n=r.querySelectorAll("li[id*='brf']");n=n[n.length-1],n?r.insertBefore(i,n.nextSibling):r.insertBefore(i,r.firstChild)}createContextMenuSeparator(){let e=document.querySelector("#bricks-builder-context-menu ul");const t=document.createElement("li");t.classList.add("sep");let r=e.querySelectorAll("li[id*='brf']");r=r[r.length-1],r&&e.insertBefore(t,r.nextSibling)}getActiveElement(e=!1){return this.bricksState.activeElement?e?(this.bricksActiveElementObject=this.bricksState.activeElement,this.bricksState.activeElement):(this.bricksActiveElement=this.bricksState.activeElement.name,this.bricksState.activeElement.name):null}handleProForms(){this.handleProFormsPanel()}handleProFormsPanel(e=!1){const t=["email","confirmation","redirect","mailchimp","sendgrid","registration","login","pro_forms_post_action_post_create","pro_forms_post_action_post_update","pro_forms_post_action_post_delete","pro_forms_post_action_update_post_meta","pro_forms_post_action_add_option","pro_forms_post_action_update_option","pro_forms_post_action_delete_option","updateUserMeta","resetUserPassword","pro_forms_post_action_set_storage_item","submissions","wcAddToCart","webhook"];let r=document.querySelectorAll(".control-group[data-control-group]"),i=[];r.forEach((e=>{t.includes(e.dataset.controlGroup)&&e.querySelectorAll("input[type='text']").forEach((e=>{e.closest(".options-wrapper")||i.push(e)}))})),0!=i.length&&i.forEach((e=>{if(e.parentNode.querySelector(".bricksforge-panel-handler"))return;const t=document.createElement("div");t.classList.add("bricksforge-panel-handler");const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("viewBox","0 0 2048 2048"),r.setAttribute("width","24"),r.setAttribute("height","24"),r.innerHTML='<path fill="#000000" d="M1072 732H848l-159 743q-17 78-58 158t-100 146t-136 107t-164 42q-26 0-53-5t-49-17t-36-32t-15-52q0-40 24-68t67-29q25 0 45 11t36 28t29 38t25 40l7 12q32-2 58-22t46-50t37-67t28-75t20-72t14-59l167-777H505l20-81h173l12-62q16-80 54-161t97-146t133-105t166-41q26 0 53 5t49 17t37 32t14 52q0 42-22 70t-68 29q-32 0-53-12t-36-32t-27-42t-26-45q-37 2-66 28t-51 66t-39 90t-27 97t-20 91t-13 69h226zm664 64q-25 20-53 53t-54 69t-50 74t-40 65q10 41 19 81t20 81q10 37 22 77t34 73t52 55t78 22q12 0 28-1t32-4t32-6t27-9l-16 59q-30 13-56 24t-53 19t-54 12t-62 5q-44 0-72-12t-47-35t-31-55t-24-70q-14-44-25-87t-22-88q-38 60-76 115t-83 110q-20 24-40 46t-43 39t-51 27t-60 10q-42 0-69-24t-28-68q0-26 10-45t27-33t39-19t46-7q30 0 57 11t57 19q57-57 106-121t88-134l-2-10q-4-19-12-51t-17-69t-22-77t-24-72t-26-57t-27-33q-34-20-77-20q-27 0-56 5t-54 17l16-60q14-6 42-17t58-22t58-19t42-8q44 0 73 14t50 39t33 58t24 71q11 39 20 79t18 81l2 8v3q0 1 1 3q19-30 41-68t48-78t55-78t63-69t70-48t78-19q39 0 66 26t28 66q0 25-10 44t-26 32t-38 19t-45 7q-26 0-58-8t-57-17"/>',r.addEventListener("click",(()=>{this.handleProFormsPanel()})),t.setAttribute("data-balloon","Pro Forms Panel"),t.setAttribute("data-balloon-pos","top-right"),t.appendChild(r),e.parentNode.insertBefore(t,e.nextSibling)}))}proFormsPanelClickHandler=e=>{let t={x:e.clientX+75,y:e.clientY-100};t.y>window.innerHeight-419&&(t.y=window.innerHeight-434);let r=e.target.closest(".control").querySelector("input");document.querySelector("#bricksforge-pro-forms-panel");this.handleProFormsPanelInit(t,r)};handleProFormsPanelInit(e,t){const r=document.querySelector("#bricksforge-pro-forms-panel");if(r){const i=r.querySelector(".bricksforge-pro-forms-panel__content");return i.innerHTML="",e&&(r.style.left=e.x+"px",r.style.top=e.y+"px"),void this.handleProFormsPanelContent(i,t)}const i=document.createElement("div");i.id="bricksforge-pro-forms-panel",e&&(i.style.left=e.x+"px",i.style.top=e.y+"px");const n=document.createElement("div");n.classList.add("bricksforge-pro-forms-panel__content");const o=document.createElement("div");o.classList.add("bricksforge-pro-forms-panel__header");const s=document.createElement("div");s.classList.add("bricksforge-pro-forms-panel__header-title"),s.innerHTML="Pro Forms";const c=document.createElement("div");c.classList.add("bricksforge-pro-forms-panel__header-close"),c.innerHTML='<i class="fas fa-times"></i>',o.appendChild(s),o.appendChild(c),i.appendChild(o),i.appendChild(n),document.body.appendChild(i),o.addEventListener("mousedown",(e=>{e.preventDefault();let t=e.clientX,r=e.clientY;function n(e){let n=t-e.clientX,o=r-e.clientY;const s=i.getBoundingClientRect();let c=s.left-n,l=s.top-o;c>=0&&l>=0&&c+s.width<=window.innerWidth&&l+s.height<=window.innerHeight&&(i.style.left=c+"px",i.style.top=l+"px"),t=e.clientX,r=e.clientY}document.addEventListener("mousemove",n),document.addEventListener("mouseup",(()=>{document.removeEventListener("mousemove",n)}))})),c.addEventListener("click",(()=>{i.remove()})),this.handleProFormsPanelContent(n,t)}handleProFormsPanelContent(e,t){let r=this.getActiveElement(!0).id;if(!this.bricksIframe)return;let i=this.bricksIframe.querySelector(".brxe-brf-pro-forms[data-script-id='"+r+"']");if(i||(i=document.querySelector("#bricks-builder-iframe").contentWindow.document.querySelector(".brxe-brf-pro-forms[data-script-id='"+r+"']")),!i)return void(e.innerHTML="<p style='margin-left: 20px'>No variables found.</p>");let n=i.querySelectorAll("[data-custom-id]"),o=[];n.forEach((e=>{o.push({id:e.dataset.customId,label:e.querySelector("label")?e.querySelector("label").textContent.trim():"Field"})}));const s=document.createElement("h2");s.innerHTML="Form Fields";const c=document.createElement("ul");c.classList.add("bricksforge-pro-forms-panel__list"),o.forEach((e=>{const r=document.createElement("li");r.classList.add("bricksforge-pro-forms-panel__list-item"),r.innerHTML='<span class="label">'+e.label+"</span><span class='id'>"+e.id+"</span>",c.appendChild(r),r.addEventListener("click",(()=>{t.value="{{"+e.id+"}}";const r=new Event("input",{bubbles:!0,cancelable:!0});t.dispatchEvent(r)}))})),e.appendChild(s),e.appendChild(c)}handleProFormsAi(){const e=document.querySelector(".bricks-panel-controls");if(e&&!e.querySelector(".bricksforge-button-ai")){const t=this.createButton("Bricksforge Assistant","block",{marginBottom:"-10px"},null,(()=>{this.bricksforgeStoreAi.showAiModal=!0}));e.prepend(t)}}handleProFormsDuplicatedIds(){this.refreshState();const e=this.bricksContent.filter((e=>e.name.includes("brf-pro-forms-field")));if(!e)return;const t=e.map((e=>[e.settings.id,e.parent])).filter(((e,t,r)=>r.indexOf(e[0])!==t));t&&t.forEach((t=>{let r=t[0],i=t[1],n=e.filter((e=>e.settings.id===r&&e.parent==i));if(n.length>1){const e=n[n.length-1];this.updateElementSetting(e.id,"id",this.bricksRoot.$_generateId())}}))}generateRandomId(){return Math.random().toString(36).substr(2,9)}createButton(e,t="block",r={},i={},n=null){const o=document.createElement("button"),s=document.createElement("div");if("block"===t)s.classList.add("bricksforge-button-wrapper"),o.classList.add("button"),o.classList.add("block"),o.classList.add("bricksforge-button"),o.classList.add("bricksforge-button-ai");if(o.innerText=e,r)for(const[e,t]of Object.entries(r))o.style[e]=t;if(i)for(const[e,t]of Object.entries(i))o.setAttribute(e,t);return n&&o.addEventListener("click",n),s.appendChild(o),s}updateElementSetting(e,t,r){this.refreshState();const i=this.bricksContent.find((t=>t.id===e));i&&i.settings&&(i.settings[t]=r)}hideMessages(){document.querySelectorAll("#bricks-message").forEach((e=>{e.setAttribute("data-hidden","true")}))}showMessages(){document.querySelectorAll("#bricks-message").forEach((e=>{e.removeAttribute("data-hidden")}))}async runCreateTerminalShortcut(){if(!this.getActiveElement(!0))return;let e=null;if(document.querySelectorAll("#bricks-builder-context-menu li").forEach((t=>{!t.querySelector(".shortcut")||"CMD + C"!=t.querySelector(".shortcut").innerText&&"CTRL + C"!=t.querySelector(".shortcut").innerText||(e=t)})),!e||!BRFTERMINAL)return;let t=BRFTERMINAL.commands;BRFTERMINAL.initTerminal(),BRFTERMINAL.setScope("basic");let r=await BRFTERMINAL.openTerminal({placeholder:"Enter Terminal Command. Example: new-command"});if(t.filter((e=>e.shortcut==r)).length>0)return alert("This name already exists!"),void BRFTERMINAL.finish();e.click();const i=await navigator.clipboard.readText();let n={id:this.generateRandomId(),shortcut:r,data:i,status:"active",tags:[]};"object"==typeof t&&t.push(n);try{if(200==(await fetch(BRFBUILDER.apiurl+"save_option",{method:"POST",headers:{"X-WP-Nonce":BRFBUILDER.nonce,"Content-Type":"application/json"},body:JSON.stringify(["brf_terminal_commands",t])})).status)return BRFTERMINAL.success("New Terminal Command Created!"),void BRFTERMINAL.finish({newCommand:n})}catch(e){console.log(e),BRFTERMINAL.finish()}BRFTERMINAL.finish()}}document.addEventListener("DOMContentLoaded",(()=>{!bricksIsFrontend&&document.querySelector("#bricks-toolbar")&&setTimeout((()=>{BRFBUILDER={...BRFBUILDER,...new BricksforgeBuilder}}),1e3)}));